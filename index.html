<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Liste Anime (CRUD)</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://ydmqxamsgotncqhqvcgt.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbXF4YW1zZ290bmNxaHF2Y2d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNDMyMjAsImV4cCI6MjA3MTcxOTIyMH0.AtUSpfLpklsGzTEKnl2QjKeEcmPNOTEhXiosWivK0Gk'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const tbody = document.querySelector("#dataTable tbody")
    const form = document.getElementById("animeForm")
    const formTitle = document.getElementById("formTitle")
    const modal = document.getElementById("modal")
    const openModalBtn = document.getElementById("openModal")
    const closeModalBtn = document.getElementById("closeModal")
    const filtersDiv = document.getElementById("filters")

    let editingId = null
    let allAnimes = [] // pour stocker et filtrer localement
    let selectedTags = new Set()

    // ouvrir / fermer la popup
    openModalBtn.addEventListener("click", () => {
      modal.classList.add("show")
    })
    closeModalBtn.addEventListener("click", () => {
      modal.classList.remove("show")
      editingId = null
      form.reset()
      formTitle.textContent = "Ajouter un anime"
    })

    // charger la liste
    async function loadAnimes() {
      const { data, error } = await supabase.from('animes').select('*').order('id', { ascending: false })
      if (error) return console.error(error)
      allAnimes = data
      buildFilters()
      renderTable()
    }

    // construire dynamiquement les filtres √† partir des tags
    function buildFilters() {
      filtersDiv.innerHTML = ""
      const tagsSet = new Set()
      allAnimes.forEach(a => {
        if (a.tags) a.tags.forEach(t => tagsSet.add(t))
      })
      tagsSet.forEach(tag => {
        const label = document.createElement("label")
        label.innerHTML = `<input type="checkbox" value="${tag}"> ${tag}`
        label.querySelector("input").addEventListener("change", (e) => {
          if (e.target.checked) {
            selectedTags.add(tag)
          } else {
            selectedTags.delete(tag)
          }
          renderTable()
        })
        filtersDiv.appendChild(label)
      })
    }

    // rendu du tableau avec filtre
    function renderTable() {
  tbody.innerHTML = ""
  let filtered = allAnimes

  const checked = [...document.querySelectorAll(".tagFilter:checked")].map(cb => cb.value)

  if (checked.length > 0) {
    filtered = filtered.filter(anime =>
      anime.tags && checked.every(tag => anime.tags.includes(tag))
    )
  }

  filtered.forEach(animes => {
    const tr = document.createElement("tr")
    tr.classList.add("fade-in")
    tr.innerHTML = `
      <td>${animes.titre_jp || ''}</td>
      <td>${animes.titre_en || ''}</td>
      <td>${animes.titre_fr || ''}</td>
      <td>${animes.description || ''}</td>
      <td>${animes.description_perso || ''}</td>
      <td>${animes.note || ''}</td>
      <td>${animes.tags ? animes.tags.join(', ') : ''}</td>
      <td>${animes.date || ''}</td>
      <td>
        <button class="edit" onclick="editAnimes(${animes.id})">‚úèÔ∏è</button>
        <button class="delete" onclick="deleteAnimes(${animes.id})">üóëÔ∏è</button>
      </td>
    `
    tbody.appendChild(tr)
  })
}


    // ajout / √©dition
    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      const animes = {
        titre_jp: form.titre_jp.value,
        titre_en: form.titre_en.value,
        titre_fr: form.titre_fr.value,
        description: form.description.value,
        description_perso: form.description_perso.value,
        note: parseFloat(form.note.value) || null,
        tags: form.tags.value.split(',').map(t => t.trim()).filter(t => t !== ""),
        date: form.date.value || null,
        poster_url: form.poster_url.value
      }

      if (editingId) {
        await supabase.from('animes').update(animes).eq('id', editingId)
        showNotification("‚úèÔ∏è Anime modifi√©")
      } else {
        await supabase.from('animes').insert([animes])
        showNotification("‚úÖ Anime ajout√©")
      }

      editingId = null
      form.reset()
      formTitle.textContent = "Ajouter un anime"
      modal.classList.remove("show")
      loadAnimes()
    })

    // suppression
    window.deleteAnimes = async function(id) {
      if (confirm("Supprimer cet anime ?")) {
        await supabase.from('animes').delete().eq('id', id)
        showNotification("üóëÔ∏è Anime supprim√©")
        loadAnimes()
      }
    }

    // √©dition
    window.editAnimes = async function(id) {
      const { data } = await supabase.from('animes').select('*').eq('id', id).single()
      if (!data) return
      editingId = id
      formTitle.textContent = "Modifier un anime"
      form.titre_jp.value = data.titre_jp || ''
      form.titre_en.value = data.titre_en || ''
      form.titre_fr.value = data.titre_fr || ''
      form.description.value = data.description || ''
      form.description_perso.value = data.description_perso || ''
      form.note.value = data.note || ''
      form.tags.value = data.tags ? data.tags.join(', ') : ''
      form.date.value = data.date || ''
      form.poster_url.value = data.poster_url || ''
      modal.classList.add("show")
    }

    function showNotification(message) {
      const notif = document.createElement("div")
      notif.className = "notification"
      notif.textContent = message
      document.body.appendChild(notif)
      setTimeout(() => notif.classList.add("show"), 50)
      setTimeout(() => notif.classList.remove("show"), 2000)
      setTimeout(() => notif.remove(), 2500)
    }

    loadAnimes()
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2 { text-align: center; }
    #openModal {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      background: #4cafef;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #openModal:hover { background: #3a9ed9; }
    /* Modal */
    #modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #modal.show {
      visibility: visible;
      opacity: 1;
    }
    #modalContent {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    input, textarea, button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 5px 0;
      width: 100%;
    }
    button.delete { background: #e74c3c; color: #fff; }
    button.edit { background: #f39c12; color: #fff; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { padding: 12px; border-bottom: 1px solid #eee; }
    th { background: #f0f2f5; }
    tr.fade-in { animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
    .notification {
      position: fixed; top:20px; right:20px;
      background:#4caf50; color:#fff; padding:10px 15px;
      border-radius:8px; opacity:0; transform:translateY(-10px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .notification.show { opacity:1; transform:translateY(0); }
    .filters {
      margin: 20px; text-align: center;
    }
    .filters label {
      margin: 0 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <button id="openModal">‚ûï Ajouter</button>
  <h2>Liste des animes</h2>

  <div class="filters" id="filters"></div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Titre JP</th>
        <th>Titre EN</th>
        <th>Titre FR</th>
        <th>Description</th>
        <th>Perso</th>
        <th>Note</th>
        <th>Tags</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h1 id="formTitle">Ajouter un anime</h1>
      <form id="animeForm">
        <input name="titre_jp" placeholder="Titre JP" required>
        <input name="titre_en" placeholder="Titre EN">
        <input name="titre_fr" placeholder="Titre FR">
        <textarea name="description" placeholder="Description"></textarea>
        <textarea name="description_perso" placeholder="Description perso"></textarea>
        <input name="note" placeholder="Note" type="number" step="0.1">
        <input name="tags" placeholder="Tags (s√©par√©s par virgules)">
        <input name="date" type="date">
        <input name="poster_url" placeholder="Lien image">
        <button type="submit">üíæ Sauvegarder</button>
      </form>
      <button id="closeModal">‚ùå Fermer</button>
    </div>
  </div>
</body>
</html>

